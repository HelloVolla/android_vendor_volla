From 36f0979a87b11d92b3b3981a1366d83eba4c521a Mon Sep 17 00:00:00 2001
From: luka177 <lukapanio@gmail.com>
Date: Mon, 14 Nov 2022 13:00:08 +0100
Subject: [PATCH] Volla Add MicroG Setup

Change-Id: I7edd4479810316231adf8050c11c67076b31d4e0
---
 AndroidManifest.xml                           | 13 +++
 res/drawable/microg_icon.xml                  | 23 +++++
 res/layout/setup_volla_microg.xml             | 97 +++++++++++++++++++
 res/raw/lineage_wizard_script.xml             |  4 +
 res/raw/wizard_script.xml                     |  3 +
 res/values-de/microg.xml                      | 21 ++++
 res/values/microg.xml                         | 21 ++++
 .../lineageos/setupwizard/FinishActivity.java | 13 +++
 .../lineageos/setupwizard/SetupWizardApp.java |  1 +
 .../setupwizard/VollaMicrogActivity.java      | 84 ++++++++++++++++
 10 files changed, 280 insertions(+)
 create mode 100644 res/drawable/microg_icon.xml
 create mode 100644 res/layout/setup_volla_microg.xml
 create mode 100644 res/values-de/microg.xml
 create mode 100644 res/values/microg.xml
 create mode 100644 src/org/lineageos/setupwizard/VollaMicrogActivity.java

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 8645baf..0f7cb63 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -253,6 +253,19 @@
             </intent-filter>
         </activity>
 
+        <activity android:name=".VollaMicrogActivity"
+                  android:label="@string/activity_label_empty"
+                  android:excludeFromRecents="true"
+                  android:configChanges="mcc|mnc"
+                  android:immersive="true"
+                  android:exported="false"
+                  android:windowSoftInputMode="stateAlwaysHidden">
+            <intent-filter>
+                <action android:name="org.lineageos.setupwizard.LINEAGE_MICROG" />
+                <category android:name="android.intent.category.DEFAULT" />
+            </intent-filter>
+        </activity>
+
         <activity android:name=".NavigationSettingsActivity"
                   android:label="@string/activity_label_empty"
                   android:excludeFromRecents="true"
diff --git a/res/drawable/microg_icon.xml b/res/drawable/microg_icon.xml
new file mode 100644
index 0000000..c48b5a1
--- /dev/null
+++ b/res/drawable/microg_icon.xml
@@ -0,0 +1,23 @@
+<vector android:height="24dp" android:viewportHeight="225.27478"
+    android:viewportWidth="225.27477" android:width="24dp" xmlns:android="http://schemas.android.com/apk/res/android">
+    <path android:fillAlpha="1" android:fillColor="#f2f2f2"
+        android:pathData="M112.637,112.637m-105.551,0a105.551,105.551 0,1 1,211.102 0a105.551,105.551 0,1 1,-211.102 0"
+        android:strokeAlpha="1" android:strokeColor="#00000000"
+        android:strokeLineCap="butt" android:strokeWidth="30.57332802"/>
+    <path android:fillAlpha="1" android:fillColor="#00000000"
+        android:pathData="m151.55,151.528a55,55 0,0 1,-66.391 8.741"
+        android:strokeAlpha="1" android:strokeColor="#e91e63"
+        android:strokeLineCap="butt" android:strokeWidth="30"/>
+    <path android:fillAlpha="1" android:fillColor="#00000000"
+        android:pathData="M85.159,160.269A55,55 0,0 1,59.534 98.402"
+        android:strokeAlpha="1" android:strokeColor="#ff9800"
+        android:strokeLineCap="butt" android:strokeWidth="30"/>
+    <path android:fillAlpha="1" android:fillColor="#00000000"
+        android:pathData="m59.534,98.402a55,55 0,0 1,25.626 -33.396"
+        android:strokeAlpha="1" android:strokeColor="#cddc39"
+        android:strokeLineCap="butt" android:strokeWidth="30"/>
+    <path android:fillAlpha="1" android:fillColor="#00000000"
+        android:pathData="m85.159,65.006a55,55 0,0 1,66.391 8.741"
+        android:strokeAlpha="1" android:strokeColor="#009688"
+        android:strokeLineCap="butt" android:strokeWidth="30"/>
+</vector>
diff --git a/res/layout/setup_volla_microg.xml b/res/layout/setup_volla_microg.xml
new file mode 100644
index 0000000..d02f534
--- /dev/null
+++ b/res/layout/setup_volla_microg.xml
@@ -0,0 +1,97 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2015 The CyanogenMod Project
+     Copyright (C) 2017-2021 The LineageOS Project
+     Copyright (C) 2021 The Calyx Institute
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+          http://www.apache.org/licenses/LICENSE-2.0
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<com.google.android.setupdesign.GlifLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:id="@+id/setup_wizard_layout"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent">
+
+    <LinearLayout
+        android:orientation="vertical"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        style="@style/SudContentFrame">
+
+        <FrameLayout
+            android:id="@+id/page"
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1">
+
+            <ScrollView android:layout_width="match_parent"
+                        android:layout_height="match_parent"
+                        android:fillViewport="true">
+
+                <LinearLayout
+                    android:orientation="vertical"
+                    android:layout_width="match_parent"
+                    android:layout_height="match_parent">
+
+                    <include layout="@layout/divider" />
+
+                    <LinearLayout
+                        android:id="@+id/switchLayout"
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:background="?android:attr/selectableItemBackground"
+                        android:gravity="center_vertical"
+                        android:orientation="horizontal"
+                        android:paddingTop="16dp"
+                        android:paddingBottom="16dp"
+                        android:paddingLeft="@dimen/content_margin_left"
+                        android:paddingRight="@dimen/data_switch_margin_right">
+
+                        <TextView
+                            android:layout_width="0dp"
+                            android:layout_height="wrap_content"
+                            android:layout_weight="1"
+                            android:text="@string/microg_switch_label"
+                            android:textSize="15sp" />
+
+                        <Switch
+                            android:id="@+id/enableSwitch"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:checked="false" />
+
+                    </LinearLayout>
+
+                    <include layout="@layout/divider" />
+
+                    <TextView
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:paddingTop="16dp"
+                        android:paddingLeft="@dimen/content_margin_left"
+                        android:paddingRight="@dimen/content_margin_right"
+                        android:text="@string/microg_warning"
+                        android:layout_weight="1"
+                        android:textSize="15sp" />
+
+                    <include layout="@layout/divider" />
+
+                </LinearLayout>
+            </ScrollView>
+        </FrameLayout>
+
+        <org.lineageos.setupwizard.NavigationLayout
+            android:id="@+id/navigation_bar"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content" />
+
+    </LinearLayout>
+</com.google.android.setupdesign.GlifLayout>
diff --git a/res/raw/lineage_wizard_script.xml b/res/raw/lineage_wizard_script.xml
index cb404eb..e71c8fb 100644
--- a/res/raw/lineage_wizard_script.xml
+++ b/res/raw/lineage_wizard_script.xml
@@ -56,6 +56,10 @@
     </WizardAction>
 
     <WizardAction wizard:uri="intent:#Intent;action=org.lineageos.setupwizard.LINEAGE_SETTINGS;end" id="lineage_settings">
+        <result wizard:action="microg" />
+    </WizardAction>
+
+    <WizardAction wizard:uri="intent:#Intent;action=org.lineageos.setupwizard.LINEAGE_MICROG;end" id="microg">
         <result wizard:action="navigation_settings" />
     </WizardAction>
 
diff --git a/res/raw/wizard_script.xml b/res/raw/wizard_script.xml
index 5953193..ccd1286 100644
--- a/res/raw/wizard_script.xml
+++ b/res/raw/wizard_script.xml
@@ -115,6 +115,9 @@
         <result wizard:action="lineage_settings" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=org.lineageos.setupwizard.LINEAGE_SETTINGS;end" id="lineage_settings">
+        <result wizard:action="microg" />
+    </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=org.lineageos.setupwizard.LINEAGE_MICROG;end" id="microg">
         <result wizard:action="navigation_settings" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=org.lineageos.setupwizard.NAVIGATION_SETTINGS;end" id="navigation_settings">
diff --git a/res/values-de/microg.xml b/res/values-de/microg.xml
new file mode 100644
index 0000000..5fb095c
--- /dev/null
+++ b/res/values-de/microg.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 Volla Systeme GmbH
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="microg_title">MicroG</string>
+    <string name="microg_warning">Die Systemerweiterung simuliert Google Play Dienste für die Ausführung von Apps, die diese nutzen. Es handelt sich um eine quelloffene Software, die unter der Apache 2.0 Lizenz veröffentlicht wurde. 2019 wurde sie vom Bundesministerium für Bildung und Forschung der Bundesrepublik Deutschland und dem Prototype Fund gefördert. Die Volla Systeme GmbH als Herausgeber von Volla OS übernimmt keine Haftung für Fehler der Software, eventuelle Schäden oder Ansprüche Dritter. Der Anwender stimmt für die Installation dem Haftungsausschluss zu. Erfahren Sie mehr über die Systemerweiterung unter microG.org.</string>
+    <string name="microg_switch_label">Aktivieren Sie MicroG</string>
+</resources>
diff --git a/res/values/microg.xml b/res/values/microg.xml
new file mode 100644
index 0000000..6cfb278
--- /dev/null
+++ b/res/values/microg.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 Volla Systeme GmbH
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="microg_title">MicroG</string>
+    <string name="microg_warning">The system extension simulates Google Play services for running apps that use them. It is open source software released under the Apache 2.0 License. In 2019, it was funded by the Federal Ministry of Education and Research of the Federal Republic of Germany and the Prototype Fund. Volla Systeme GmbH as the publisher of Volla OS assumes no liability for errors in the software, possible damages or claims Drtter. The user agrees to the disclaimer for the installation.  Learn more about the system extension at microG.org.</string>
+    <string name="microg_switch_label">Enable MicroG</string>
+</resources>
diff --git a/src/org/lineageos/setupwizard/FinishActivity.java b/src/org/lineageos/setupwizard/FinishActivity.java
index 95e3166..59ed1af 100644
--- a/src/org/lineageos/setupwizard/FinishActivity.java
+++ b/src/org/lineageos/setupwizard/FinishActivity.java
@@ -30,6 +30,7 @@ import static org.lineageos.setupwizard.SetupWizardApp.KEY_SEND_METRICS;
 import static org.lineageos.setupwizard.SetupWizardApp.LOGV;
 import static org.lineageos.setupwizard.SetupWizardApp.NAVIGATION_OPTION_KEY;
 import static org.lineageos.setupwizard.SetupWizardApp.UPDATE_RECOVERY_PROP;
+import static org.lineageos.setupwizard.SetupWizardApp.ENABLE_MICROG;
 
 import android.animation.Animator;
 import android.app.Activity;
@@ -179,6 +180,7 @@ public class FinishActivity extends BaseSetupWizardActivity {
         handleNavKeys(mSetupWizardApp);
         handleRecoveryUpdate(mSetupWizardApp);
         handleNavigationOption(mSetupWizardApp);
+        handleEnableMicrog(mSetupWizardApp);
         final WallpaperManager wallpaperManager =
                 WallpaperManager.getInstance(mSetupWizardApp);
         wallpaperManager.forgetLoadedWallpaper();
@@ -241,4 +243,15 @@ public class FinishActivity extends BaseSetupWizardActivity {
                     UserHandle.USER_CURRENT);
         }
     }
+
+    private static void handleEnableMicrog(SetupWizardApp setupWizardApp) {
+        Bundle microgValue = setupWizardApp.getSettingsBundle();
+        if (microgValue != null
+                && microgValue.containsKey(ENABLE_MICROG)) {
+            LineageSettings.System.putIntForUser(setupWizardApp.getContentResolver(),
+                    LineageSettings.System.ENABLE_MICROG,
+                    microgValue.getBoolean(ENABLE_MICROG) ? 1 : 0,
+                    UserHandle.USER_CURRENT);
+        }
+    }
 }
diff --git a/src/org/lineageos/setupwizard/SetupWizardApp.java b/src/org/lineageos/setupwizard/SetupWizardApp.java
index dcfe3bc..cd2248c 100644
--- a/src/org/lineageos/setupwizard/SetupWizardApp.java
+++ b/src/org/lineageos/setupwizard/SetupWizardApp.java
@@ -64,6 +64,7 @@ public class SetupWizardApp extends Application {
     public static final String DISABLE_NAV_KEYS = "disable_nav_keys";
     public static final String ENABLE_RECOVERY_UPDATE = "enable_recovery_update";
     public static final String UPDATE_RECOVERY_PROP = "persist.vendor.recovery_update";
+    public static final String ENABLE_MICROG = "enable_microg";
 
     public static final String NAVIGATION_OPTION_KEY = "navigation_option";
 
diff --git a/src/org/lineageos/setupwizard/VollaMicrogActivity.java b/src/org/lineageos/setupwizard/VollaMicrogActivity.java
new file mode 100644
index 0000000..4be1ad6
--- /dev/null
+++ b/src/org/lineageos/setupwizard/VollaMicrogActivity.java
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2019 The Calyx Institute
+ *
+ *  Licensed under the Apache License, Version 2.0 (the "License");
+ *  you may not use this file except in compliance with the License.
+ *  You may obtain a copy of the License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package org.lineageos.setupwizard;
+
+import android.annotation.Nullable;
+import android.app.Activity;
+import android.content.Context;
+import android.content.Intent;
+import android.os.Bundle;
+import android.util.Log;
+import android.widget.Switch;
+import com.google.android.setupcompat.util.WizardManagerHelper;
+import org.lineageos.setupwizard.BaseSetupWizardActivity;
+import org.lineageos.setupwizard.R;
+
+import lineageos.providers.LineageSettings;
+
+import static android.content.pm.PackageManager.COMPONENT_ENABLED_STATE_DISABLED;
+import static android.content.pm.PackageManager.COMPONENT_ENABLED_STATE_ENABLED;
+import static org.lineageos.setupwizard.SetupWizardApp.ENABLE_MICROG;
+
+public class VollaMicrogActivity extends BaseSetupWizardActivity {
+
+    public static final String TAG = VollaMicrogActivity.class.getSimpleName();
+
+    private Switch enableSwitch;
+    private SetupWizardApp mSetupWizardApp;
+
+    @Override
+    protected void onCreate(@Nullable Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        mSetupWizardApp = (SetupWizardApp) getApplication();
+
+        setNextText(R.string.next);
+        enableSwitch = findViewById(R.id.enableSwitch);
+        findViewById(R.id.switchLayout).setOnClickListener(v -> enableSwitch.toggle());
+    }
+
+    @Override
+    public void onResume() {
+        super.onResume();
+
+        final Bundle myPageBundle = mSetupWizardApp.getSettingsBundle();
+        final boolean checked = myPageBundle.getBoolean(ENABLE_MICROG, false);
+        enableSwitch.setChecked(checked);
+    }
+
+    @Override
+    protected void onNextPressed() {
+        mSetupWizardApp.getSettingsBundle().putBoolean(ENABLE_MICROG,
+                enableSwitch.isChecked());
+
+        Intent intent = WizardManagerHelper.getNextIntent(getIntent(), Activity.RESULT_OK);
+        nextAction(NEXT_REQUEST, intent);
+    }
+
+    @Override
+    protected int getLayoutResId() {
+        return R.layout.setup_volla_microg;
+    }
+
+    @Override
+    protected int getTitleResId() {
+        return R.string.microg_title;
+    }
+
+    @Override
+    protected int getIconResId() {
+        return R.drawable.ic_features;
+    }
+}
-- 
2.29.2

