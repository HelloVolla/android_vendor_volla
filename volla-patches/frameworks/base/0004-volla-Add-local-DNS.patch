From edcabcb214885aede94a3f325b1da3fc913ea158 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Sun, 20 Feb 2022 10:05:50 +0100
Subject: [PATCH 2/2] volla: Add local DNS

Change-Id: I353dc2f92a9c2a231e81e0888935ba8f1f1cdcef
---
 .../com/android/server/connectivity/DnsManager.java    | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/connectivity/DnsManager.java b/services/core/java/com/android/server/connectivity/DnsManager.java
index cf6a7f6e8d7..6b572f8b4cd 100644
--- a/services/core/java/com/android/server/connectivity/DnsManager.java
+++ b/services/core/java/com/android/server/connectivity/DnsManager.java
@@ -360,7 +360,7 @@ public class DnsManager {
         // networks like IMS.
         final PrivateDnsConfig privateDnsCfg = mPrivateDnsMap.getOrDefault(netId,
                 PRIVATE_DNS_OFF);
-        final boolean useTls = privateDnsCfg.useTls;
+        boolean useTls = privateDnsCfg.useTls;
         final boolean strictMode = privateDnsCfg.inStrictMode();
 
         paramsParcel.netId = netId;
@@ -381,6 +381,14 @@ public class DnsManager {
                 : new String[0];            // Off
         paramsParcel.resolverOptions = new ResolverOptionsParcel();
         paramsParcel.transportTypes = transportTypes;
+
+        if (mSystemProperties.getBoolean("persist.volla.firewall.enable", false)) {
+            useTls = false;
+            paramsParcel.tlsServers = new String[0];
+            paramsParcel.domains = new String[0];
+            paramsParcel.tlsName = "";
+            paramsParcel.servers = new String[]{"127.0.0.1"};
+        }
         // Prepare to track the validation status of the DNS servers in the
         // resolver config when private DNS is in opportunistic or strict mode.
         if (useTls) {
-- 
2.25.1

