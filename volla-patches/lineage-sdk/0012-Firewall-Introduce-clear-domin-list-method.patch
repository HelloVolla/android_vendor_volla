From 7fc5004e486cafbb4f3e7007e19aa3c765108624 Mon Sep 17 00:00:00 2001
From: Erfan Abdi <erfangplus@gmail.com>
Date: Tue, 20 Sep 2022 19:21:04 +0430
Subject: [PATCH] Firewall: Introduce clear domin list method

Change-Id: I176c0905667933914328d53d51a564454486dfcd
---
 api/lineage_current.txt                             |  1 +
 .../platform/internal/FirewallService.java          | 13 +++++++++++++
 .../java/lineageos/firewall/FirewallManager.java    |  8 ++++++++
 .../java/lineageos/firewall/IFirewallService.aidl   |  2 ++
 4 files changed, 24 insertions(+)

diff --git a/api/lineage_current.txt b/api/lineage_current.txt
index 0ff48212..a7ade8e1 100644
--- a/api/lineage_current.txt
+++ b/api/lineage_current.txt
@@ -885,6 +885,7 @@ package lineageos.firewall {
     method public boolean isDomainOnList(java.lang.String);
     method public int getDomainsListCount();
     java.util.List<java.lang.String> getDomainsList();
+    method public void clearDomainList();
   }
 
 }
diff --git a/lineage/lib/main/java/org/lineageos/platform/internal/FirewallService.java b/lineage/lib/main/java/org/lineageos/platform/internal/FirewallService.java
index 29efc022..80659464 100644
--- a/lineage/lib/main/java/org/lineageos/platform/internal/FirewallService.java
+++ b/lineage/lib/main/java/org/lineageos/platform/internal/FirewallService.java
@@ -391,6 +391,14 @@ public class FirewallService extends LineageSystemService {
         return mDomainsList.size();
     }
 
+    private void clearDomainList() {
+        if (!mDomainsList.isEmpty()) {
+            mDomainsList.clear();
+            mHandler.sendEmptyMessage(FirewallHandler.MSG_WRITE_STATE);
+            mHandler.sendEmptyMessage(FirewallHandler.MSG_WRITE_CONF);
+        }
+    }
+
     private String getBlockedPage() {
         InputStream inputStream = mContext.getResources().openRawResource(org.lineageos.platform.internal.R.raw.firewall);
         ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
@@ -456,6 +464,11 @@ public class FirewallService extends LineageSystemService {
         public List<String> getDomainsList() {
             return FirewallService.this.getDomainsList();
         }
+
+        @Override
+        public void clearDomainList() {
+            FirewallService.this.clearDomainList();
+        }
     };
 
     private class FirewallHandler extends Handler {
diff --git a/sdk/src/java/lineageos/firewall/FirewallManager.java b/sdk/src/java/lineageos/firewall/FirewallManager.java
index 10a2c649..b9a60d6b 100644
--- a/sdk/src/java/lineageos/firewall/FirewallManager.java
+++ b/sdk/src/java/lineageos/firewall/FirewallManager.java
@@ -144,4 +144,12 @@ public class FirewallManager {
             throw e.rethrowFromSystemServer();
         }
     }
+
+    public void clearDomainList() {
+        try {
+            sService.clearDomainList();
+        } catch (RemoteException e) {
+            throw e.rethrowFromSystemServer();
+        }
+    }
 }
diff --git a/sdk/src/java/lineageos/firewall/IFirewallService.aidl b/sdk/src/java/lineageos/firewall/IFirewallService.aidl
index d9d9d67b..d5588e81 100644
--- a/sdk/src/java/lineageos/firewall/IFirewallService.aidl
+++ b/sdk/src/java/lineageos/firewall/IFirewallService.aidl
@@ -36,4 +36,6 @@ interface IFirewallService {
     int getDomainsListCount();
 
     List<String> getDomainsList();
+
+    void clearDomainList();
 }
-- 
2.29.2

